<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>3D Building Dashboard - OSM + MapLibre</title>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<style>
html, body { margin:0; padding:0; height:100%; width:100%; font-family: Arial,sans-serif;}
#container { display:flex; width:100%; height:100%; }
#sidePanel { width:350px; height:100%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; box-sizing:border-box; overflow-y:auto; box-shadow:2px 0 10px rgba(0,0,0,0.3); }
#map { flex:1; height:100%; }
.panel-section { margin-bottom:25px; background: rgba(255,255,255,0.1); padding:15px; border-radius:10px; backdrop-filter:blur(10px);}
.panel-title { font-size:18px; font-weight:bold; margin-bottom:15px; color:#fff; border-bottom:2px solid rgba(255,255,255,0.3); padding-bottom:8px;}
.stat-item { display:flex; justify-content:space-between; margin-bottom:10px; padding:8px; background:rgba(255,255,255,0.1); border-radius:5px;}
.color-legend { display:flex; align-items:center; margin-bottom:8px; }
.color-box { width:20px; height:20px; border-radius:3px; margin-right:10px; border:1px solid rgba(255,255,255,0.3);}
input, select, button { width:100%; padding:8px; margin-bottom:10px; border:none; border-radius:5px; font-size:14px; }
button { background:linear-gradient(45deg,#FF6B6B,#4ECDC4); color:white; cursor:pointer; font-weight:bold; transition:0.2s;}
button:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(0,0,0,0.3);}
.filter-controls { display:flex; gap:10px; }
.filter-controls input { flex:1; }
#stats { font-size:12px;}
</style>
</head>
<body>

<div id="container">
  <div id="sidePanel">
    <h2 style="text-align:center; margin-bottom:30px; color:#fff;">ğŸ¢ Building Dashboard</h2>
    
    <!-- Statistics -->
    <div class="panel-section">
      <div class="panel-title">ğŸ“Š Statistics</div>
      <div id="stats">
        <div class="stat-item"><span>Total Buildings:</span><span id="totalBuildings">0</span></div>
        <div class="stat-item"><span>Avg Height:</span><span id="avgHeight">0m</span></div>
        <div class="stat-item"><span>Max Height:</span><span id="maxHeight">0m</span></div>
        <div class="stat-item"><span>Total Area:</span><span id="totalArea">0 sq.m</span></div>
      </div>
    </div>

    <!-- Color Legend -->
    <div class="panel-section">
      <div class="panel-title">ğŸ¨ Height Color Code</div>
      <div class="color-legend"><div class="color-box" style="background:lightgray;"></div><span>3m</span></div>
      <div class="color-legend"><div class="color-box" style="background:royalblue;"></div><span>6m</span></div>
      <div class="color-legend"><div class="color-box" style="background:lightblue;"></div><span>9m</span></div>
      <div class="color-legend"><div class="color-box" style="background:red;"></div><span>12m+</span></div>
    </div>

    <!-- Compliance Legend -->
    <div class="panel-section">
      <div class="panel-title">âœ… Compliance</div>
      <div class="color-legend"><div class="color-box" style="background:gray;"></div>Not Applicable</div>
      <div class="color-legend"><div class="color-box" style="background:green;"></div>Compliant</div>
      <div class="color-legend"><div class="color-box" style="background:orange;"></div>Partial Compliance</div>
      <div class="color-legend"><div class="color-box" style="background:red;"></div>Non-compliant</div>
    </div>

    <!-- Analysis -->
    <div class="panel-section">
      <div class="panel-title">ğŸ“ˆ Quick Analysis</div>
      <button onclick="highlightTallBuildings()">ğŸ—ï¸ Show Tall Buildings</button>
      <button onclick="highlightByPropertyType()">ğŸ¢ Group by Property Type</button>
      <button onclick="showFloodProne()">ğŸŒŠ Flood Prone Areas</button>
      <button onclick="highlightByCompliance()">âœ… Compliance Status</button>
      <button onclick="resetMapView()">ğŸŒ Reset View</button>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
const map = new maplibregl.Map({
    container: 'map',
    style: {version:8,sources:{osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'Â© OpenStreetMap contributors'}},layers:[{id:'osm',type:'raster',source:'osm'}]},
    center: [85.854, 20.466],
    zoom: 17,
    pitch: 60,
    bearing: -17,
    antialias: true
});
map.dragRotate.enable();
map.touchZoomRotate.enableRotation();
map.addControl(new maplibregl.NavigationControl());

let allBuildings = [];
fetch('./Sector6Final1.geojson').then(res=>res.json()).then(data=>{
    allBuildings = data.features.map(f=>{
        f.properties.height = parseFloat(f.properties.height_m||f.properties.height||3);
        f.properties.floors = parseInt(f.properties.floors||1);
        f.properties.compliance = f.properties.Compliance || "Not Applicable";
        return f;
    });
    map.on('load',()=>{
        map.addSource('buildings',{type:'geojson',data:{type:'FeatureCollection',features:allBuildings}});
        map.addLayer({
            id:'buildings-layer',
            type:'fill-extrusion',
            source:'buildings',
            paint:{
                'fill-extrusion-color':['interpolate', ['linear'], ['get','height'],
                    3,'lightgray',
                    6,'royalblue',
                    9,'lightblue',
                    12,'red'
                ],
                'fill-extrusion-height':['*',['get','height'],1],
                'fill-extrusion-base':0,
                'fill-extrusion-opacity':0.9
            }
        });
        updateStatistics();
    });
});

function updateStatistics(){
    const heights = allBuildings.map(b=>b.properties.height);
    const total = allBuildings.length;
    const avg = total>0?(heights.reduce((a,b)=>a+b,0)/total).toFixed(1):0;
    const maxH = total>0?Math.max(...heights):0;
    document.getElementById('totalBuildings').innerText = total;
    document.getElementById('avgHeight').innerText = avg+'m';
    document.getElementById('maxHeight').innerText = maxH+'m';
    const totalArea = allBuildings.reduce((a,b)=>a+(b.properties.AREA||0),0);
    document.getElementById('totalArea').innerText = totalArea.toFixed(1)+' sq.m';
}

// Compliance Analysis
function highlightByCompliance(){
    const colorMap = {
        "Not Applicable":"gray",
        "Coverage 87.0% > 65%":"green",
        "Coverage 87.0% > 65%; FSI 1.74 > 1.5":"green",
        "Coverage 87.0% > 60%; FSI 2.61 > 1.5; Height 9m > 8m":"orange",
        "Coverage 87.0% > 60%; FSI 1.74 > 1.5":"orange",
        "Coverage 86.9% > 65%":"orange",
        "Coverage 87.1% > 65%":"orange",
        "Coverage 87.0% > 55%; FSI 3.48 > 1.75; Height 12m > 9m":"red",
        "Coverage 86.8% > 65%":"orange",
        "Coverage 87.2% > 65%":"green",
        "Coverage 86.7% > 65%":"orange",
        "No rule found":"gray",
        "Coverage 87.0% > 50%; FSI 3.48 > 2.0":"red"
    };
    map.setPaintProperty('buildings-layer','fill-extrusion-color',['match',['get','compliance'],
        "Not Applicable","gray",
        "Coverage 87.0% > 65%","green",
        "Coverage 87.0% > 65%; FSI 1.74 > 1.5","green",
        "Coverage 87.0% > 60%; FSI 2.61 > 1.5; Height 9m > 8m","orange",
        "Coverage 87.0% > 60%; FSI 1.74 > 1.5","orange",
        "Coverage 86.9% > 65%","orange",
        "Coverage 87.1% > 65%","orange",
        "Coverage 87.0% > 55%; FSI 3.48 > 1.75; Height 12m > 9m","red",
        "Coverage 86.8% > 65%","orange",
        "Coverage 87.2% > 65%","green",
        "Coverage 86.7% > 65%","orange",
        "No rule found","gray",
        "Coverage 87.0% > 50%; FSI 3.48 > 2.0","red",
        "gray"
    ]);
}

// Additional analysis functions (tall buildings, property type, flood) can be added similarly
function highlightTallBuildings(){ map.setPaintProperty('buildings-layer','fill-extrusion-color',['case',['>=',['get','height'],12],'red','lightgray']); }
function resetMapView(){ map.flyTo({center:[85.854,20.466],zoom:17,bearing:-17,pitch:60}); }

</script>
</body>
</html>
