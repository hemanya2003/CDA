<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>3D Building Dashboard - MapLibre + OSM</title>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<!-- Chart.js + DataLabels plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
html, body { 
    margin: 0; 
    padding: 0; 
    height: 100%; 
    width: 100%; 
    font-family: Arial, sans-serif; 
}

#container { 
    display: flex; 
    width: 100%; 
    height: 100%; 
}

#sidePanel { 
    width: 350px; 
    height: 100%; 
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white; 
    padding: 20px; 
    box-sizing: border-box; 
    overflow-y: auto; 
    box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
}

#map { 
    flex: 1; 
    height: 100%; 
}

.panel-section { 
    margin-bottom: 25px; 
    background: rgba(255,255,255,0.1); 
    padding: 15px; 
    border-radius: 10px; 
    backdrop-filter: blur(10px); 
}

.panel-title { 
    font-size: 18px; 
    font-weight: bold; 
    margin-bottom: 15px; 
    border-bottom: 2px solid rgba(255,255,255,0.3); 
    padding-bottom: 8px; 
}

.stat-item { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 10px; 
    padding: 8px; 
    background: rgba(255,255,255,0.1); 
    border-radius: 5px; 
}

canvas { 
    margin-top: 15px; 
    background: #fff; 
    border-radius: 8px; 
    padding: 10px;
    width: 100% !important;
    height: 200px !important;
}

/* Filter Controls Styling */
label {
    display: block;
    margin: 10px 0 5px 0;
    font-weight: bold;
    font-size: 14px;
}

select, input[type="number"] {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 5px;
    margin-bottom: 10px;
    font-size: 14px;
    background: rgba(255,255,255,0.9);
    color: #333;
}

.filter-controls {
    display: flex;
    gap: 10px;
}

.filter-controls input {
    flex: 1;
}

button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: none;
    border-radius: 5px;
    background: rgba(255,255,255,0.2);
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background 0.3s;
}

button:hover {
    background: rgba(255,255,255,0.3);
}

#errorMessage {
    background: rgba(255,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    display: none;
}

.loading {
    text-align: center;
    padding: 20px;
    font-style: italic;
}
</style>
</head>
<body>
<div id="container">
  <div id="sidePanel">
    <h2 style="text-align:center; margin-bottom:30px;">üè¢ Building Dashboard</h2>
    
    <div id="errorMessage"></div>
    <div id="loadingMessage" class="loading">Loading building data...</div>
    
    <!-- Statistics -->
    <div class="panel-section" id="statsSection" style="display:none;">
      <div class="panel-title">üìä Statistics</div>
      <div id="stats">
        <div class="stat-item"><span>Total Buildings:</span><span id="totalBuildings">0</span></div>
        <div class="stat-item"><span>Avg Height:</span><span id="avgHeight">0m</span></div>
        <div class="stat-item"><span>Max Height:</span><span id="maxHeight">0m</span></div>
        <div class="stat-item"><span>Total Area:</span><span id="totalArea">0 sq.m</span></div>
      </div>
      <!-- Two pie charts -->
      <canvas id="propertyChart"></canvas>
      <canvas id="complianceChart"></canvas>
    </div>

    <!-- Filters -->
    <div class="panel-section" id="filtersSection" style="display:none;">
      <div class="panel-title">üîç Spatial Queries</div>
      <label>Property Type:</label>
      <select id="propertyTypeFilter">
        <option value="">All Types</option>
        <option value="Commercial">Commercial</option>
        <option value="Institutional">Institutional</option>
        <option value="Vacant">Vacant</option>
        <option value="Residential">Residential</option>
        <option value="Mixed Use">Mixed Use</option>
      </select>
      
      <label>Building Use:</label>
      <select id="buildingUseFilter">
        <option value="">All Uses</option>
        <option value="House">House</option>
        <option value="Shop">Shop</option>
        <option value="Warehouse">Warehouse</option>
      </select>
      
      <label>Height Range (meters):</label>
      <div class="filter-controls">
        <input type="number" id="minHeight" placeholder="Min" min="0">
        <input type="number" id="maxHeight" placeholder="Max" min="0">
      </div>
      
      <label>Floor Count:</label>
      <select id="floorsFilter">
        <option value="">All Floors</option>
        <option value="1">1 Floor</option>
        <option value="2">2 Floors</option>
        <option value="3">3+ Floors</option>
      </select>
      
      <button onclick="applyFilters()">üîé Apply Filters</button>
      <button onclick="resetFilters()">üîÑ Reset All</button>
    </div>
    
    <!-- Analysis -->
    <div class="panel-section" id="analysisSection" style="display:none;">
      <div class="panel-title">üìà Quick Analysis</div>
      <button onclick="highlightTallBuildings()">üèóÔ∏è Show Tall Buildings</button>
      <button onclick="highlightByPropertyType()">üè¢ Group by Property Type</button>
      <button onclick="highlightByCompliance()">‚úÖ Compliance Status</button>
      <button onclick="resetMapView()">üåç Reset View</button>
    </div>
  </div>
  <div id="map"></div>
</div>

<script>
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        sources: {
            osm: {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '¬© OpenStreetMap contributors'
            }
        },
        layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
    },
    center: [85.854, 20.466],
    zoom: 17,
    pitch: 60,
    bearing: -17,
    antialias: true
});

map.addControl(new maplibregl.NavigationControl());

let allBuildings = [];
let propertyChart, complianceChart;

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('loadingMessage').style.display = 'none';
}

function showSections() {
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('statsSection').style.display = 'block';
    document.getElementById('filtersSection').style.display = 'block';
    document.getElementById('analysisSection').style.display = 'block';
}

// Load building data
fetch('./Sector6Final1.geojson')
  .then(res => {
      if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
  })
  .then(data => {
      console.log("GeoJSON loaded successfully");
      console.log("First feature properties:", data.features[0]?.properties);
      
      if (!data.features || data.features.length === 0) {
          throw new Error('No building features found in GeoJSON');
      }
      
      allBuildings = data.features.map(f => {
          // Normalize height
          f.properties.height = parseFloat(f.properties.height_m || f.properties.height || 3);
          
          // Normalize floors
          f.properties.floors = parseInt(f.properties.floors || 1);
          
          // Normalize property type
          f.properties.Property_T = f.properties.Property_T || f.properties.property_type || "Unknown";
          
          // Normalize building use
          f.properties.Building_U = f.properties.Building_U || f.properties.building_use || "Unknown";
          
          // Fix compliance field - check multiple possible field names
          const complianceField = f.properties.Compliance_Status || 
                                 f.properties.compliance_status ||
                                 f.properties.Compliance || 
                                 f.properties.compliance || 
                                 f.properties.COMPLIANCE ||
                                 f.properties.Complianc ||
                                 "Unknown";
          
          f.properties.Compliance_Status = complianceField;
          
          return f;
      });

      map.on('load', () => {
          map.addSource('buildings', { 
              type: 'geojson', 
              data: { type: 'FeatureCollection', features: allBuildings }
          });          
          
          map.addLayer({
              id: 'buildings-layer',
              type: 'fill-extrusion',
              source: 'buildings',
              paint: {
                  'fill-extrusion-color': [
                      'interpolate', ['linear'], ['get', 'height'],
                      3, 'lightgray',
                      6, 'royalblue',
                      9, 'lightblue',
                      12, 'red'
                  ],
                  'fill-extrusion-height': ['get', 'height'],
                  'fill-extrusion-base': 0,
                  'fill-extrusion-opacity': 0.9
              }
          });

          // Show stats & charts on load
          updateStatistics(allBuildings);
          updateCharts(allBuildings);
          showSections();
          
          // Debug compliance values
          console.log("Sample compliance values:");
          const complianceValues = allBuildings.map(b => b.properties.Compliance_Status);
          const uniqueValues = [...new Set(complianceValues)];
          console.log("Unique compliance values:", uniqueValues);
          
          const counts = {};
          complianceValues.forEach(val => {
              counts[val] = (counts[val] || 0) + 1;
          });
          console.log("Compliance counts:", counts);

          // Popup on click
          map.on('click', 'buildings-layer', (e) => {
              const p = e.features[0].properties;
              new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(`
                  <b>Plot No:</b> ${p.Plot_No || "NA"}<br/>
                  <b>Owner:</b> ${p.Owner_Name || "NA"}<br/>
                  <b>Father/Husband:</b> ${p.Father_Hus || "NA"}<br/>
                  <b>Contact:</b> ${p.Contact_Nu || "NA"}<br/>
                  <b>Occupancy:</b> ${p.Occupancy_ || "NA"}<br/>
                  <b>Property Type:</b> ${p.Property_T || "NA"}<br/>
                  <b>Height:</b> ${p.height}m<br/>
                  <b>Floors:</b> ${p.floors}<br/>
                  <b>Compliance:</b> ${p.Compliance_Status || "NA"}
                `)
                .addTo(map);
          });

          // Change cursor on hover
          map.on('mouseenter', 'buildings-layer', () => {
              map.getCanvas().style.cursor = 'pointer';
          });
          map.on('mouseleave', 'buildings-layer', () => {
              map.getCanvas().style.cursor = '';
          });
      });
  })
  .catch(error => {
      console.error('Error loading building data:', error);
      showError('Failed to load building data: ' + error.message);
  });

function updateStatistics(features) {
    const heights = features.map(b => b.properties.height);
    const total = features.length;
    const avg = total > 0 ? (heights.reduce((a, b) => a + b, 0) / total).toFixed(1) : 0;
    const maxH = total > 0 ? Math.max(...heights) : 0;
    
    document.getElementById('totalBuildings').innerText = total;
    document.getElementById('avgHeight').innerText = avg + 'm';
    document.getElementById('maxHeight').innerText = maxH + 'm';
    
    const totalArea = features.reduce((a, b) => a + (parseFloat(b.properties.AREA) || 0), 0);
    document.getElementById('totalArea').innerText = totalArea.toFixed(1) + ' sq.m';
}

function updateCharts(features) {
    // Property type chart
    const propertyTypeCounts = {
        'Commercial': 0,
        'Institutional': 0,
        'Vacant': 0,
        'Residential': 0,
        'Mixed Use': 0,
        'Unknown': 0
    };
    
    features.forEach(f => {
        const type = f.properties.Property_T || 'Unknown';
        if (propertyTypeCounts[type] !== undefined) {
            propertyTypeCounts[type]++;
        } else {
            propertyTypeCounts['Unknown']++;
        }
    });

    // Remove categories with 0 count for cleaner chart
    const filteredPropertyTypes = {};
    Object.keys(propertyTypeCounts).forEach(key => {
        if (propertyTypeCounts[key] > 0) {
            filteredPropertyTypes[key] = propertyTypeCounts[key];
        }
    });

    const ctx1 = document.getElementById('propertyChart').getContext('2d');
    if (propertyChart) propertyChart.destroy();
    
    propertyChart = new Chart(ctx1, {
        type: 'pie',
        data: {
            labels: Object.keys(filteredPropertyTypes),
            datasets: [{
                data: Object.values(filteredPropertyTypes),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Property Types'
                },
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, fontSize: 10 }
                },
                datalabels: {
                    color: '#000',
                    formatter: (value, context) => {
                        return value > 0 ? value : '';
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Compliance chart
    const complianceCounts = {
        'Not Applicable': 0,
        'No rule found': 0,
        'Violations': 0,
        'Unknown': 0
    };
    
    features.forEach(f => {
        const status = f.properties.Compliance_Status || 'Unknown';
        if (status === 'Not Applicable') {
            complianceCounts['Not Applicable']++;
        } else if (status === 'No rule found') {
            complianceCounts['No rule found']++;
        } else if (status === 'Unknown') {
            complianceCounts['Unknown']++;
        } else {
            complianceCounts['Violations']++;
        }
    });

    // Remove categories with 0 count
    const filteredCompliance = {};
    Object.keys(complianceCounts).forEach(key => {
        if (complianceCounts[key] > 0) {
            filteredCompliance[key] = complianceCounts[key];
        }
    });

    const ctx2 = document.getElementById('complianceChart').getContext('2d');
    if (complianceChart) complianceChart.destroy();
    
    complianceChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: Object.keys(filteredCompliance),
            datasets: [{
                data: Object.values(filteredCompliance),
                backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Compliance Status'
                },
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, fontSize: 10 }
                },
                datalabels: {
                    color: '#000',
                    formatter: (value, context) => {
                        return value > 0 ? value : '';
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function applyFilters() {
    const type = document.getElementById('propertyTypeFilter').value;
    const use = document.getElementById('buildingUseFilter').value;
    const minH = parseFloat(document.getElementById('minHeight').value) || 0;
    const maxH = parseFloat(document.getElementById('maxHeight').value) || 9999;
    const floors = document.getElementById('floorsFilter').value;

    const filtered = allBuildings.filter(b => {
        let matches = true;
        
        if (type && b.properties.Property_T !== type) matches = false;
        if (use && b.properties.Building_U !== use) matches = false;
        if (!(b.properties.height >= minH && b.properties.height <= maxH)) matches = false;
        
        if (floors) {
            if (floors === "3" && b.properties.floors < 3) matches = false;
            else if (floors !== "3" && b.properties.floors != parseInt(floors)) matches = false;
        }
        
        return matches;
    });

    map.getSource('buildings').setData({
        type: 'FeatureCollection',
        features: filtered
    });
    
    updateStatistics(filtered);
    updateCharts(filtered);
}

function resetFilters() {
    document.getElementById('propertyTypeFilter').value = "";
    document.getElementById('buildingUseFilter').value = "";
    document.getElementById('minHeight').value = "";
    document.getElementById('maxHeight').value = "";
    document.getElementById('floorsFilter').value = "";
    
    map.getSource('buildings').setData({
        type: 'FeatureCollection',
        features: allBuildings
    });
    
    updateStatistics(allBuildings);
    updateCharts(allBuildings);
}

function highlightTallBuildings() {
    map.setPaintProperty('buildings-layer', 'fill-extrusion-color',
        ['case', ['>=', ['get', 'height'], 10], 'orange', 'lightgray']
    );
}

function highlightByPropertyType() {
    map.setPaintProperty('buildings-layer', 'fill-extrusion-color',
        ['match', ['get', 'Property_T'],
            'Commercial', '#FF6384',
            'Institutional', '#36A2EB', 
            'Vacant', '#6c757d',
            'Residential', '#4BC0C0',
            'Mixed Use', '#9966FF',
            'lightgray'
        ]
    );
}

function highlightByCompliance() {
    map.setPaintProperty('buildings-layer', 'fill-extrusion-color',
        ['case',
            ['==', ['get', 'Compliance_Status'], 'Not Applicable'], '#28a745',
            ['==', ['get', 'Compliance_Status'], 'No rule found'], '#ffc107',
            '#dc3545'
        ]
    );
}

function resetMapView() {
    map.flyTo({
        center: [85.854, 20.466],
        zoom: 17,
        pitch: 60,
        bearing: -17
    });
    
    map.setPaintProperty('buildings-layer', 'fill-extrusion-color',
        ['interpolate', ['linear'], ['get', 'height'],
            3, 'lightgray',
            6, 'royalblue',
            9, 'lightblue',
            12, 'red'
        ]
    );
}
</script>
</body>
</html>
